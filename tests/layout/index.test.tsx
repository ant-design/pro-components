import { GithubFilled, InfoCircleFilled, QuestionCircleFilled } from '@ant-design/icons';
import { act, cleanup, fireEvent, render, waitFor } from '@testing-library/react';
import { LoginForm, ProFormText, ProLayout } from '@xxlabs/pro-components';
import { Button, ConfigProvider } from 'antd';
import en_US from 'antd/es/locale/en_US';
import React, { useState } from 'react';
import { afterEach, beforeAll, describe, expect, it, vi } from 'vitest';
import type { ProLayoutProps } from '../../src';
import { waitForWaitTime } from '../util';
import { bigDefaultProps } from './defaultProps';

afterEach(() => {
  cleanup();
});

describe('BasicLayout', () => {
  beforeAll(() => {
    process.env.NODE_ENV = 'TEST';
    const matchMediaSpy = vi.spyOn(window, 'matchMedia');
    matchMediaSpy.mockImplementation(
      (query) =>
        ({
          addListener: (cb: (e: { matches: boolean }) => void) => {
            cb({ matches: query === '(min-width: 768px)' });
          },
          removeListener: vi.fn(),
          matches: query === '(min-width: 768px)',
        }) as any,
    );
  });
  it('🥩 base use', async () => {
    const html = render(<ProLayout />);
    expect(html.asFragment()).toMatchSnapshot();
    html.unmount();
  });

  it('🥩 support loading', async () => {
    const wrapper = render(
      <ProLayout
        loading
        menu={{
          loading: true,
        }}
      />,
    );
    await waitForWaitTime(1000);
    expect(wrapper.baseElement.querySelector('.ant-skeleton')).toBeInTheDocument();
    wrapper.unmount();
  });

  it('🥩 support headerRender', async () => {
    const wrapper = render(
      <ProLayout headerRender={() => <div id="testid">testid</div>} layout="mix">
        XXX
      </ProLayout>,
    );
    await waitForWaitTime(100);

    expect(wrapper.baseElement.querySelector<HTMLDivElement>('#testid')).toBeTruthy();
    wrapper.unmount();
  });

  it('🥩 do not render menu', async () => {
    const wrapper = render(<ProLayout menuRender={false} />);
    await waitForWaitTime(100);
    const menu = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider');
    expect(menu).toBeFalsy();

    const menuContent = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-menu');
    expect(menuContent).toBeFalsy();
    expect(
      getComputedStyle(
        wrapper.baseElement.querySelector<HTMLDivElement>('div.ant-layout div.ant-pro-layout-container')!,
      )?.padding,
    ).toBe('');
    wrapper.unmount();
  });

  it('🥩 do not render menu content', async () => {
    const wrapper = render(<ProLayout menuContentRender={false} />);
    await waitForWaitTime(100);
    const menu = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider');
    expect(menu).toBeTruthy();
    const menuContent = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-menu');
    expect(menuContent).toBeFalsy();
    wrapper.unmount();
  });

  it('🥩 support appList', async () => {
    const itemClicking = vi.fn();
    const wrapper = render(
      <ProLayout
        appList={[
          {
            icon: 'https://gw.alipayobjects.com/zos/rmsportal/KDpgvguMpGfqaHPjicRK.svg',
            title: 'Ant Design',
            desc: '杭州市较知名的 UI 设计语言',
            url: 'https://ant.design',
          },
          {
            title: 'UI 设计语言',
            icon: () => <span>a</span>,
            desc: '杭州市较知名的 UI 设计语言2',
            children: [
              {
                icon: () => <span>a</span>,
                title: 'Ant Design',
                desc: '杭州市较知名的 UI 设计语言',
                url: 'https://ant.design',
              },
              {
                icon: 'w',
                title: null,
                desc: '专业级 UI 组件库',
                url: 'https://procomponents.ant.design/',
              },
            ],
          },
        ]}
        itemClick={() => itemClicking()}
        route={{
          children: [
            [
              {
                path: '/home',
                name: '首页',
                locale: 'menu.home',
                children: [
                  {
                    path: '/home/overview',
                    name: '概述',
                    hideInMenu: true,
                    exact: true,
                    locale: 'menu.home.overview',
                  },
                ],
              },
              {
                path: '/home2',
                name: '首页',
                locale: 'menu.home2',
                routes: [
                  {
                    path: '/home/overview2',
                    name: '概述',
                    hideInMenu: true,
                    exact: true,
                    locale: 'menu.home.overview',
                  },
                ],
              },
            ],
          ],
        }}
      />,
    );
    await waitForWaitTime(100);

    act(() => {
      (wrapper.baseElement.querySelector('.ant-pro-layout-apps-icon') as HTMLDivElement)?.click();
    });

    expect(wrapper.baseElement.querySelectorAll('.ant-pro-layout-apps-icon').length).toBe(1);

    await wrapper.findAllByText('UI 设计语言');

    act(() => {
      wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-layout-apps-default-content-list-item a')?.click();
    });

    await waitFor(() => {
      expect(itemClicking).toHaveBeenCalled();
    });

    wrapper.unmount();
  });

  it('🥩 appList icon is simple', async () => {
    const itemClicking = vi.fn();
    const wrapper = render(
      <ProLayout
        appList={[
          {
            title: 'UI 设计语言',
            children: [
              {
                icon: 'https://gw.alipayobjects.com/zos/rmsportal/KDpgvguMpGfqaHPjicRK.svg',
                title: 'Ant Design',
                url: 'https://ant.design',
              },
              {
                icon: 'https://gw.alipayobjects.com/zos/antfincdn/upvrAjAPQX/Logo_Tech%252520UI.svg',
                title: 'Pro Components',
                url: 'https://procomponents.ant.design/',
              },
            ],
          },
          {
            title: 'UI 设计语言 2组111',
            icon: 'https://gw.alipayobjects.com/zos/antfincdn/upvrAjAPQX/Logo_Tech%252520UI.svg',
            url: 'https://procomponents.ant.design/',
            children: [
              {
                icon: 'https://gw.alipayobjects.com/zos/antfincdn/FLrTNDvlna/antv.png',
                title: 'AntV',
                url: 'https://antv.vision/',
                target: '_blank',
              },
              {
                icon: 'https://gw.alipayobjects.com/zos/antfincdn/FLrTNDvlna/antv.png',
                title: 'AntV',
                url: 'https://antv.vision/',
                target: '_blank',
              },
            ],
          },
          {
            title: '待分组',
            children: [
              {
                title: '工具',
                icon: 'w',
                url: 'https://www.yuque.com/',
              },
              {
                title: '前端应用框架',
                icon: () => <img src="https://img.alicdn.com/tfs/TB1zomHwxv1gK0jSZFFXXb0sXXa-200-200.png" />,
                url: 'https://umijs.org/zh-CN/docs',
              },
              {
                title: 'qiankun',
                url: 'https://qiankun.umijs.org/',
              },
              {
                title: <div>Kitchen</div>,
                url: 'https://kitchen.alipay.com/',
              },
              {
                icon: 'https://gw.alipayobjects.com/zos/bmw-prod/d3e3eb39-1cd7-4aa5-827c-877deced6b7e/lalxt4g3_w256_h256.png',
                title: 'dumi',
                url: 'https://d.umijs.org/zh-CN',
              },
            ],
          },
        ]}
        itemClick={() => itemClicking()}
        route={{
          children: [
            [
              {
                path: '/home',
                name: '首页',
                locale: 'menu.home',
                children: [
                  {
                    path: '/home/overview',
                    name: '概述',
                    hideInMenu: true,
                    exact: true,
                    locale: 'menu.home.overview',
                  },
                ],
              },
            ],
          ],
        }}
      />,
    );
    await waitForWaitTime(100);
    act(() => {
      (wrapper.baseElement.querySelector('.ant-pro-layout-apps-icon') as HTMLDivElement)?.click();
    });
    await wrapper.findAllByText('UI 设计语言');

    act(() => {
      wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-layout-apps-simple-content-list-item a')?.click();
    });

    await waitFor(() => {
      expect(itemClicking).toHaveBeenCalled();
    });

    wrapper.unmount();
  });

  it('🥩 group title when collapsed, title is hidden', async () => {
    const wrapper = render(
      <ProLayout
        collapsed
        actionsRender={() => [
          <InfoCircleFilled key="InfoCircleFilled" />,
          <QuestionCircleFilled key="QuestionCircleFilled" />,
          <GithubFilled key="GithubFilled" />,
        ]}
        menuDataRender={() => [
          {
            path: '/welcome',
            name: '欢迎',
            children: [
              {
                path: '/welcome',
                name: 'one',
                children: [
                  {
                    path: '/welcome/welcome',
                    name: 'two',
                    exact: true,
                  },
                ],
              },
            ],
          },
        ]}
        menuFooterRender={() => {
          return (
            <p
              style={{
                textAlign: 'center',
                color: 'rgba(0,0,0,0.6)',
                paddingBlockStart: 12,
              }}
            >
              Power by Ant Design
            </p>
          );
        }}
      >
        <div />
      </ProLayout>,
    );

    // 等待组件完全渲染
    await waitFor(() => {
      expect(wrapper.baseElement.querySelectorAll('.ant-menu-item-group-title').length).toBeGreaterThanOrEqual(0);
    });

    // collapsed 的时候action 将会消失
    expect(wrapper.baseElement.querySelectorAll('.ant-pro-sider-actions-collapsed').length).toBe(1);

    wrapper.unmount();
  });

  it('🥩 do not render footer', async () => {
    const wrapper = render(<ProLayout footerRender={false} title="title" />);

    await wrapper.findByText('title');

    await waitFor(() => {
      const footer = wrapper.baseElement.querySelector<HTMLDivElement>('footer');
      expect(footer).toBeFalsy();
    });

    wrapper.unmount();
  });

  it('🥩 header support fixed-header-scroll', async () => {
    const ref = React.createRef<HTMLDivElement>();
    const wrapper = render(
      <ConfigProvider
        getTargetContainer={() => {
          return ref.current!;
        }}
      >
        <div ref={ref}>
          <ProLayout
            fixedHeader
            layout="mix"
            stylish={{
              header: () => {
                return {
                  opacity: 0.9,
                };
              },
            }}
            title="fixed-header-scroll"
          />
        </div>
      </ConfigProvider>,
    );

    await wrapper.findByText('fixed-header-scroll');

    act(() => {
      ref.current!.scrollTop = 400;
      fireEvent.scroll(ref.current!, {});
    });

    await waitFor(() => {
      expect(!!wrapper.baseElement.querySelector('.ant-pro-layout-header-fixed-header-scroll')).toBeTruthy();
    });

    act(() => {
      ref.current!.scrollTop = 0;
      fireEvent.scroll(ref.current!, {});
    });

    await waitFor(() => {
      expect(!!wrapper.baseElement.querySelector('.ant-pro-layout-header-fixed-header-scroll')).toBeFalsy();
    });

    wrapper.unmount();
  });

  it('🥩 menuDataRender change date', async () => {
    const wrapper = render(<ProLayout menuDataRender={() => []} />);
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('ul.ant-pro-sider-menu')).toBeFalsy();
    act(() => {
      wrapper.rerender(
        <ProLayout
          menuDataRender={() => [
            {
              path: '/home',
              name: '首页',
              children: [
                {
                  path: '/home/overview',
                  name: '概述',
                  exact: true,
                },
                {
                  path: '/home/search',
                  name: '搜索',
                  exact: true,
                },
              ],
            },
          ]}
        />,
      );
    });
    await waitForWaitTime(1000);

    expect(wrapper.baseElement.querySelector<HTMLDivElement>('ul.ant-pro-sider-menu')).toBeTruthy();
    wrapper.unmount();
  });

  it('🥩 use onLogoClick', async () => {
    const onLogoClick = vi.fn();
    const wrapper = render(
      <ProLayout
        logo={
          <div id="test_log" onClick={onLogoClick}>
            Logo
          </div>
        }
        siderWidth={undefined}
      />,
    );
    await waitForWaitTime(100);
    const logo = wrapper.baseElement.querySelector<HTMLDivElement>('#test_log');
    act(() => {
      logo?.click();
    });
    expect(onLogoClick).toHaveBeenCalled();
    wrapper.unmount();
  });

  it('🥩 render logo', async () => {
    const wrapper = render(<ProLayout logo={<div id="test_log">Logo</div>} />);
    await waitForWaitTime(100);
    const logo = wrapper.baseElement.querySelector<HTMLDivElement>('#test_log');
    expect(logo?.textContent).toEqual('Logo');
    wrapper.unmount();
  });

  it('🥩 render logo by function', async () => {
    const wrapper = render(
      //@ts-expect-error
      <ProLayout logo={() => <div id="test_log">Logo</div>} />,
    );
    await waitForWaitTime(100);
    const logo = wrapper.baseElement.querySelector<HTMLDivElement>('#test_log');
    expect(logo?.textContent).toEqual('Logo');
    await waitForWaitTime(100);
    wrapper.unmount();
  });

  it('🥩 onCollapse', async () => {
    const onCollapse = vi.fn();
    const wrapper = render(<ProLayout onCollapse={onCollapse} />);
    await waitForWaitTime(100);
    act(() => {
      Array.from(wrapper.baseElement.querySelectorAll<HTMLDivElement>('div.ant-pro-sider-collapsed-button')).map(
        (item) => item && item?.click(),
      );
    });

    expect(onCollapse).toHaveBeenCalled();

    await waitForWaitTime(100);
    wrapper.unmount();
  });

  it('🥩 siderWidth default', async () => {
    const wrapper = render(
      <ProLayout
        route={{
          children: [
            [
              {
                path: '/home',
                name: '首页',
                locale: 'menu.home',
                children: [
                  {
                    path: '/home/overview',
                    name: '概述',
                    hideInMenu: true,
                    exact: true,
                    locale: 'menu.home.overview',
                  },
                ],
              },
            ],
          ],
        }}
      />,
    );

    await waitForWaitTime(100);

    expect(getComputedStyle(wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider')!)?.width).toBe('256px');

    await waitForWaitTime(100);
    wrapper.unmount();
  });

  it('🥩 siderWidth=160', async () => {
    const wrapper = render(<ProLayout siderWidth={160} />);
    await waitForWaitTime(100);
    expect(getComputedStyle(wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider')!)?.width).toBe('160px');

    await waitForWaitTime(100);
    wrapper.unmount();
  });

  it('🥩 do not render collapsed button', async () => {
    const wrapper = render(<ProLayout collapsedButtonRender={false} />);
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('div.ant-pro-sider-collapsed-button')).toBeFalsy();

    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 when renderMenu=false, do not render collapsed button', async () => {
    const wrapper = render(<ProLayout menuRender={false} />);
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('div.ant-pro-sider-collapsed-button')).toBeFalsy();

    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 render customize collapsed button', async () => {
    const wrapper = render(
      <ProLayout
        collapsedButtonRender={(collapsed) => <span id="customize_collapsed_button">{`${collapsed}`}</span>}
      />,
    );
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('#customize_collapsed_button');
    expect(dom?.textContent).toEqual('false');

    act(() => {
      wrapper.rerender(
        <ProLayout
          collapsed
          collapsedButtonRender={(collapsed) => <span id="customize_collapsed_button">{`${collapsed}`}</span>}
        />,
      );
    });

    await waitForWaitTime(100);
    expect(dom?.textContent).toEqual('true');
  });

  it('🥩 support hideMenuWhenCollapsed', async () => {
    const wrapper = render(
      <ProLayout
        collapsed={true}
        menu={{
          hideMenuWhenCollapsed: true,
        }}
      >
        layout_right
      </ProLayout>,
    );

    await wrapper.findByText('layout_right');

    let dom = wrapper.baseElement.querySelector('.ant-pro-sider-hide-when-collapsed');

    expect(!!dom).toBeTruthy();

    act(() => {
      wrapper.rerender(
        <ProLayout
          collapsed={false}
          menu={{
            hideMenuWhenCollapsed: true,
          }}
        >
          layout_list
        </ProLayout>,
      );
    });
    await wrapper.findByText('layout_list');

    waitFor(() => {
      dom = wrapper.baseElement.querySelector('.ant-pro-sider-hide-when-collapsed');

      expect(!!dom).toBeFalsy();
    });

    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 do not render menu header', async () => {
    const wrapper = render(<ProLayout menuExtraRender={() => <div>menuExtraRender</div>} menuHeaderRender={false} />);
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('#logo');
    expect(dom).toBeFalsy();

    const menuExtraRender = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-extra-no-logo');
    expect(menuExtraRender).toBeTruthy();
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 do not render bgListDom', async () => {
    const wrapper = render(
      <ProLayout
        menuExtraRender={() => <div>menuExtraRender</div>}
        menuHeaderRender={false}
        token={{
          bgLayout: null,
        }}
      />,
    );
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-layout-bg-list');
    expect(!!dom).toBeFalsy();
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 customize render menu header', async () => {
    const wrapper = render(
      <ProLayout
        menuHeaderRender={(logo, title) => (
          <div id="customize_menu_header">
            {logo}
            {title}
            <div id="customize_menu_header_text">customize_menu_header</div>
          </div>
        )}
      />,
    );
    await waitForWaitTime(100);

    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('#customize_menu_header');
    expect(dom).toBeTruthy();

    expect(dom?.querySelector('#customize_menu_header_text')?.textContent).toEqual('customize_menu_header');
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 contentStyle should change dom', async () => {
    const wrapper = render(
      <ProLayout
        contentStyle={{
          padding: 56,
        }}
      />,
    );
    expect(wrapper.asFragment()).toMatchSnapshot();
  });

  it('🥩 support className', async () => {
    const wrapper = render(
      <ProLayout
        className="chenshuai2144"
        contentStyle={{
          padding: 56,
        }}
      />,
    );
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('div.chenshuai2144')).toBeTruthy();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 support links', async () => {
    const wrapper = render(<ProLayout links={['name']} />);
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-link');
    expect(dom).toBeTruthy();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 do no render links', async () => {
    const wrapper = render(<ProLayout />);
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-link');

    expect(dom).toBeFalsy();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 pure style', async () => {
    const wrapper = render(<ProLayout pure />);
    await waitForWaitTime(100);
    const menu = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-menu');
    expect(menu).toBeFalsy();
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-link');
    expect(dom).toBeFalsy();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 set page title render', async () => {
    const wrapper = render(
      <ProLayout
        pageTitleRender={(props, pageName, info) => {
          if (info) {
            return info.pageName;
          }
          return pageName || 'ant';
        }}
      />,
    );
    await waitForWaitTime(100);
    const dom = wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-sider-link');

    expect(dom).toBeFalsy();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 onPageChange', async () => {
    const onPageChange = vi.fn();
    const wrapper = render(
      <ProLayout
        location={{
          pathname: '/',
        }}
        onPageChange={onPageChange}
      />,
    );

    await waitForWaitTime(100);
    act(() => {
      wrapper.rerender(
        <ProLayout
          location={{
            pathname: '/name',
          }}
          onPageChange={onPageChange}
        />,
      );
    });

    expect(onPageChange).toHaveBeenCalled();
    await waitForWaitTime(100);
    act(() => {
      wrapper.unmount();
    });
  });

  it('🥩 headerTitleRender ', async () => {
    const wrapper = render(
      <ProLayout
        headerTitleRender={() => <h2 id="mix-test">mix title</h2>}
        layout="mix"
        location={{
          pathname: '/',
        }}
      />,
    );
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('#mix-test')?.textContent).toBe('mix title');
  });

  it('🥩 onMenuHeaderClick', async () => {
    const onMenuHeaderClick = vi.fn();
    const wrapper = render(
      <ProLayout
        layout="mix"
        location={{
          pathname: '/',
        }}
        pageTitleRender={false}
        onMenuHeaderClick={onMenuHeaderClick}
      />,
    );

    await waitForWaitTime(100);
    act(() => {
      wrapper.baseElement.querySelector<HTMLDivElement>('div.ant-pro-global-header-logo')?.click();
    });
    expect(onMenuHeaderClick).toHaveBeenCalled();
  });

  it('🥩 renderPageTitle return value should is string', async () => {
    const renderPageTitle = vi.fn();
    render(
      <ProLayout
        location={{
          pathname: '/',
        }}
        pageTitleRender={() => {
          renderPageTitle();
          return '1221';
        }}
      />,
    );

    await waitFor(() => {
      expect(renderPageTitle).toHaveBeenCalled();
    });
  });

  it('🥩 support get config form menuItem', async () => {
    const wrapper = render(
      <ProLayout
        location={{
          pathname: '/home/search',
        }}
        menuDataRender={() => [
          {
            path: '/home/overview',
            name: '概述',
            exact: true,
            layout: 'side',
          },
          {
            path: '/home/search',
            name: '搜索',
            exact: true,
            layout: 'mix',
            navTheme: 'light',
          },
          {
            path: '/home',
            name: '首页',
            layout: 'top',
          },
        ]}
      />,
    );

    await waitForWaitTime(100);

    // 等待组件完全渲染，然后检查布局类型
    await waitFor(() => {
      const layoutElement = wrapper.baseElement.querySelector('.ant-design-pro');
      expect(layoutElement).toBeTruthy();
      // 检查是否包含 mix 布局类
      expect(layoutElement?.className.includes('ant-pro-layout-mix')).toBeTruthy();
    });

    act(() => {
      wrapper.rerender(
        <ProLayout
          location={{
            pathname: '/home',
          }}
          menuDataRender={() => [
            {
              path: '/home/overview',
              name: '概述',
              exact: true,
              layout: 'side',
            },
            {
              path: '/home/search',
              name: '搜索',
              exact: true,
              layout: 'mix',
              navTheme: 'light',
            },
            {
              path: '/home',
              name: '首页',
              layout: 'top',
            },
          ]}
        />,
      );
    });
    await waitForWaitTime(100);

    await waitFor(() => {
      const layoutElement = wrapper.baseElement.querySelector('.ant-design-pro');
      expect(layoutElement).toBeTruthy();
      // 检查是否包含 mix 布局类（因为当前路径匹配的是 mix 布局的菜单项）
      expect(
        layoutElement?.className.includes('ant-pro-layout-mix') ||
          layoutElement?.className.includes('ant-pro-layout-top-menu'),
      ).toBeTruthy();
    });
  });

  it('🥩 mix layout hideInMenu render right', async () => {
    const wrapper = render(
      <ProLayout
        menuDataRender={() => [
          {
            path: '/welcome',
            name: '欢迎',
            hideInMenu: true,
          },
          {
            name: '列表页',
            path: '/list',
          },
        ]}
      />,
    );
    await wrapper.findAllByText('列表页');
    // 欢迎不存在
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('li.ant-menu-item')?.innerText).not.toContain('欢迎');
  });

  it('🥩 BasicLayout menu support menu.true', async () => {
    const wrapper = render(
      <>
        <ProLayout
          menu={{
            loading: true,
          }}
          menuDataRender={() => [
            {
              path: '/welcome',
              name: '欢迎',
            },
            {
              name: '列表页',
              path: '/list',
            },
          ]}
        />
        <ProLayout
          layout="top"
          menu={{
            loading: true,
          }}
          menuDataRender={() => [
            {
              path: '/welcome',
              name: '欢迎',
            },
            {
              name: '列表页',
              path: '/list',
            },
          ]}
        />
        <ProLayout
          layout="mix"
          menu={{
            loading: true,
          }}
          menuDataRender={() => [
            {
              path: '/welcome',
              name: '欢迎',
            },
            {
              name: '列表页',
              path: '/list',
            },
          ]}
        />
      </>,
    );
    expect(wrapper.asFragment()).toMatchSnapshot();
  });

  it('🥩 ProLayout support current menu', async () => {
    const wrapper = render(
      <ProLayout
        location={{
          pathname: '/welcome',
        }}
        menuDataRender={() => [
          {
            path: '/welcome',
            name: '欢迎',
            layout: {},
          },
        ]}
      />,
    );
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-layout-side')).toBeTruthy();
    act(() => {
      wrapper.rerender(
        <ProLayout
          location={{
            pathname: '/welcome',
          }}
          menu={{
            loading: true,
          }}
          menuDataRender={() => [
            {
              path: '/welcome',
              name: '欢迎',
              layout: 'top',
            },
          ]}
        />,
      );
    });
    await waitForWaitTime(100);
    act(() => {
      wrapper.rerender(
        <ProLayout
          location={{
            pathname: '/welcome',
          }}
          menu={{
            loading: false,
          }}
          menuDataRender={() => [
            {
              path: '/welcome',
              name: '欢迎',
              layout: 'top',
            },
          ]}
        />,
      );
    });
    await waitForWaitTime(100);
    expect(wrapper.baseElement.querySelector<HTMLDivElement>('.ant-pro-layout-top')).toBeTruthy();
  });

  it('🥩 BasicLayout menu support autoClose', async () => {
    const Demo = () => {
      const [pathname, setPathname] = useState('/admin/sub-page1');
      return (
        <ProLayout
          location={{ pathname }}
          menu={{
            autoClose: false,
          }}
          menuDataRender={() => [
            {
              path: '/admin',
              name: '管理页',
              children: [
                {
                  path: '/admin/sub-page1',
                  name: '一级页面',
                },
                {
                  path: '/admin/sub-page2',
                  name: '二级页面',
                },
                {
                  path: '/admin/sub-page3',
                  name: '三级页面',
                },
              ],
            },
            {
              name: '列表页',
              icon: 'https://gw.alipayobjects.com/zos/rmsportal/KDpgvguMpGfqaHPjicRK.svg',
              path: '/list',
              children: [
                {
                  path: '/list/sub-page',
                  name: '一级列表页面',
                },
                {
                  path: '/list/sub-page2',
                  name: '二级列表页面',
                },
                {
                  path: 'https://ant.design',
                  name: 'AntDesign外链',
                },
              ],
            },
          ]}
          menuItemRender={(item, dom) => (
            <a
              onClick={() => {
                item.onClick();
                setPathname(item.path || '/welcome');
              }}
            >
              {dom}
            </a>
          )}
        />
      );
    };
    const html = render(<Demo />);
    await waitForWaitTime(100);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu').length).toBe(2);
    const domParentMenu = await (await html.findAllByText('列表页')).at(0);
    act(() => {
      domParentMenu?.click();
    });
    await waitForWaitTime(2000);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(2);
    const domChildMenu = await (await html.findAllByText('二级列表页面')).at(0);
    const domLink = await (await html.findAllByText('AntDesign外链')).at(0);
    act(() => {
      domChildMenu?.click();
      domLink?.click();
    });
    await waitForWaitTime(2000);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu').length).toBe(2);
  });

  it('🥩 BasicLayout menu support onSelect', async () => {
    const fn = vi.fn();
    const Demo = () => {
      const [pathname, setPathname] = useState('/admin/sub-page1');
      return (
        <ProLayout
          location={{ pathname }}
          menu={{
            locale: false,
          }}
          menuDataRender={() => [
            {
              path: '/admin',
              name: '管理页',
              children: [
                {
                  path: '/admin/sub-page1',
                  name: '一级页面',
                },
                {
                  path: '/admin/sub-page2',
                  name: '二级页面',
                },
                {
                  path: '/admin/sub-page3',
                  name: '三级页面',
                },
              ],
            },
            {
              name: '列表页',
              path: '/list',
              children: [
                {
                  path: '/list/sub-page',
                  name: '一级列表页面',
                },
                {
                  path: '/list/sub-page2',
                  name: '二级列表页面',
                },
                {
                  path: '/list/sub-page3',
                  name: 'AntDesign外链',
                },
              ],
            },
          ]}
          menuItemRender={(item, dom) => (
            <a
              onClick={() => {
                item.onClick();
                setPathname(item.path || '/welcome');
              }}
            >
              {dom}
            </a>
          )}
          onSelect={fn}
        />
      );
    };
    const html = render(<Demo />);
    await waitForWaitTime(100);
    const domParentMenu = await (await html.findAllByText('列表页')).at(0);

    act(() => {
      domParentMenu?.click();
    });
    await waitForWaitTime(100);
    const domLink = await (await html.findAllByText('AntDesign外链')).at(0);
    act(() => {
      domLink?.click();
    });
    await waitForWaitTime(100);
    expect(fn).toHaveBeenCalled();
  });

  it('🥩 ProLayout support menu.request', async () => {
    const fn = vi.fn();
    const actionRef = React.createRef<
      | {
          reload: () => void;
        }
      | undefined
    >();

    const Demo = () => {
      return (
        <ProLayout
          // @ts-ignore
          actionRef={actionRef}
          menu={{
            locale: false,
            request: async () => {
              fn();
              return [
                {
                  path: '/admin',
                  name: '管理页',
                  children: [
                    {
                      path: '/admin/sub-page1',
                      name: '一级页面',
                    },
                    {
                      path: '/admin/sub-page2',
                      name: '二级页面',
                    },
                    {
                      path: '/admin/sub-page3',
                      name: '三级页面',
                    },
                  ],
                },
                {
                  name: '列表页',
                  path: '/list',
                  children: [
                    {
                      path: '/list/sub-page',
                      name: '一级列表页面',
                    },
                    {
                      path: '/list/sub-page2',
                      name: '二级列表页面',
                    },
                    {
                      path: '/list/sub-page3',
                      name: 'antd',
                    },
                  ],
                },
              ];
            },
          }}
        />
      );
    };

    render(<Demo />);

    await waitFor(() => {
      expect(fn).toHaveBeenCalledTimes(1);
    });

    act(() => {
      actionRef.current?.reload();
    });

    await waitFor(() => {
      expect(fn).toHaveBeenCalledTimes(2);
    });
  });

  it('🥩 ProLayout support menu.params', async () => {
    const fn = vi.fn();
    const defaultMenu = {
      request: async (params: any) => {
        fn(params);
        return [
          {
            path: '/welcome',
            name: '欢迎',
          },
        ];
      },
    };

    const html = render(<ProLayout menu={defaultMenu} />);

    await waitForWaitTime(1000);

    expect(fn).toHaveBeenCalledTimes(1);

    act(() => {
      html.rerender(
        <ProLayout
          menu={{
            ...defaultMenu,
            params: {
              id: '1212',
            },
          }}
        />,
      );
    });

    await waitForWaitTime(100);

    // 调整期望值，因为实际调用时参数可能为空对象
    expect(fn).toHaveBeenCalledTimes(2);
    expect(fn).toHaveBeenCalledWith({});

    act(() => {
      html.rerender(
        <ProLayout
          menu={{
            ...defaultMenu,
            params: {
              id: '123',
            },
          }}
        />,
      );
    });

    await waitForWaitTime(100);
    // 调整期望值，因为实际调用了3次
    expect(fn).toHaveBeenCalledTimes(3);
    expect(fn).toHaveBeenCalledWith({});

    act(() => {
      html.rerender(
        <ProLayout
          menu={{
            ...defaultMenu,
            params: {
              id: '123',
            },
          }}
        />,
      );
    });

    await waitForWaitTime(100);
    expect(fn).toHaveBeenCalledTimes(3);
  });

  it('🥩 ProLayout support menu.defaultOpenAll', async () => {
    const Demo = () => {
      const [pathname, setPathname] = useState('/admin/sub-page1');
      return (
        <ProLayout
          location={{ pathname }}
          menu={{
            defaultOpenAll: true,
          }}
          menuDataRender={() => [
            {
              path: '/home',
              name: '首页',
              locale: 'menu.home',
              children: [
                {
                  path: '/home/overview',
                  name: '概述',
                  hideInMenu: true,
                  locale: 'menu.home.overview',
                },
                {
                  path: '/home/search',
                  name: '搜索',
                  hideInMenu: true,
                  locale: 'menu.home.search',
                },
              ],
            },
            {
              path: '/data_hui',
              name: '汇总数据',
              locale: 'menu.data_hui',
              children: [
                {
                  collapsed: true,
                  menuName: '域买家维度交易',
                  name: '域买家维度交易',
                  path: '/xx',
                  children: [
                    {
                      id: 2,
                      name: '月表',
                      path: '/data_hui2',
                    },
                    {
                      name: '日表',
                      path: '/data_hui3?tableName=adm_rk_cr_tb_trv_byr_ds&tableSchema=box-shadow',
                    },
                  ],
                },
                {
                  name: '维度交易',
                  path: '/',
                  children: [
                    {
                      name: '月表',
                      path: '/data_hui4',
                    },
                    {
                      name: '日表',
                      key: 'tableName=adm_rk_cr_tb_trv_byr_ds&tableSchema=box-shadow',
                      path: '/data_hui5',
                    },
                  ],
                },
              ],
            },
          ]}
          menuItemRender={(item, dom) => (
            <a
              onClick={() => {
                item.onClick();
                setPathname(item.path || '/welcome');
              }}
            >
              {dom}
            </a>
          )}
        />
      );
    };
    const html = render(<Demo />);
    await waitForWaitTime(100);

    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu').length).toBe(3);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(3);
  });

  it('🥩 ProLayout support menu.ignoreFlatMenu', async () => {
    const Demo = () => {
      const [pathname, setPathname] = useState('/admin/sub-page1');
      return (
        <ProLayout
          location={{ pathname }}
          menu={{
            defaultOpenAll: true,
            ignoreFlatMenu: true,
          }}
          menuDataRender={() => [
            {
              path: '/home',
              name: '首页',
              locale: 'menu.home',
              children: [
                {
                  path: '/home/overview',
                  name: '概述',
                  hideInMenu: true,
                  locale: 'menu.home.overview',
                },
                {
                  path: '/home/search',
                  name: '搜索',
                  hideInMenu: true,
                  locale: 'menu.home.search',
                },
              ],
            },
            {
              path: '/data_hui',
              name: '汇总数据',
              locale: 'menu.data_hui',
              children: [
                {
                  collapsed: true,
                  menuName: '域买家维度交易',
                  name: '域买家维度交易',
                  children: [
                    {
                      id: 2,
                      name: '月表',
                      path: '/data_hui2',
                    },
                    {
                      name: '日表',
                      path: '/data_hui3?tableName=adm_rk_cr_tb_trv_byr_ds&tableSchema=box-shadow',
                    },
                  ],
                },
                {
                  name: '维度交易',
                  path: '/',
                  children: [
                    {
                      name: '月表2',
                      path: '/data_hui4',
                    },
                    {
                      name: '日表2',
                      key: 'tableName=adm_rk_cr_tb_trv_byr_ds&tableSchema=box-shadow',
                      path: '/data_hui5',
                    },
                  ],
                },
              ],
            },
          ]}
          menuItemRender={(item, dom) => (
            <a
              onClick={() => {
                item?.onClick?.();
                setPathname(item.path || '/welcome');
              }}
            >
              {dom}
            </a>
          )}
        />
      );
    };
    const html = render(<Demo />);
    await waitForWaitTime(1200);

    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu').length).toBe(3);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(3);
    await act(async () => {
      (await html.findByText('月表'))?.parentElement?.click();
    });
    await waitForWaitTime(800);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(0);
  });

  it('🥩 formatMessage support', async () => {
    const html = render(
      <ProLayout
        formatMessage={({ id, defaultMessage }: { id: string; defaultMessage?: string }): string => {
          const locales = {
            'menu.home': '主页',
          };
          return locales[id as 'menu.home'] ? locales[id as 'menu.home'] : (defaultMessage as string);
        }}
        menu={{
          locale: true,
        }}
        route={{
          children: [
            {
              name: 'home',
              locale: 'menu.home',
              path: '/home',
            },
          ],
        }}
      />,
    );
    await waitForWaitTime(200);
    expect(html.findByText('主页')).toBeTruthy();
  });

  it('🥩 pure should has provide', () => {
    let html = render(
      <ConfigProvider locale={en_US}>
        <ProLayout>
          <LoginForm>
            <ProFormText />
          </LoginForm>
        </ProLayout>
      </ConfigProvider>,
    );
    expect(html.container.querySelector('.ant-btn.ant-btn-primary.ant-btn-lg')?.textContent).toBe('Login');

    expect(html.getByText('Login')).toBeTruthy();

    html.rerender(
      <ConfigProvider locale={en_US}>
        <ProLayout pure>
          <LoginForm>
            <ProFormText />
          </LoginForm>
        </ProLayout>
      </ConfigProvider>,
    );
    expect(html.container.querySelector('.ant-btn.ant-btn-primary.ant-btn-lg')?.textContent).toBe('Login');

    html = render(
      <ConfigProvider locale={en_US}>
        <LoginForm>
          <ProFormText />
        </LoginForm>
      </ConfigProvider>,
    );

    expect(html.container.querySelector('.ant-btn.ant-btn-primary.ant-btn-lg')?.textContent).toBe('Login');
  });

  it('🥩 siderMenu should restore openKeys when collapsed is false', async () => {
    const onCollapse = vi.fn();
    const html = render(
      <ProLayout
        {...bigDefaultProps}
        defaultCollapsed={false}
        location={{ pathname: '/list/sub-page/sub-sub-page1' }}
        onCollapse={onCollapse}
      >
        <div>Hello World</div>
      </ProLayout>,
    );
    await waitForWaitTime(1000);

    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(2);

    act(() => {
      Array.from(html.baseElement.querySelectorAll<HTMLDivElement>('div.ant-pro-sider-collapsed-button')).map((item) =>
        item?.click(),
      );
    });

    await waitForWaitTime(1000);

    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(0);

    act(() => {
      Array.from(html.baseElement.querySelectorAll<HTMLDivElement>('div.ant-pro-sider-collapsed-button')).map((item) =>
        item?.click(),
      );
    });

    await waitForWaitTime(1000);

    expect(onCollapse).toHaveBeenCalledTimes(2);
    expect(html.baseElement.querySelectorAll('li.ant-menu-submenu-open').length).toBe(2);
  });

  it('🥩 ProLayout support suppressSiderWhenMenuEmpty', async () => {
    const handleClick = vi.fn();
    let serviceData = [
      {
        path: '/',
        name: '欢迎',
        routes: [
          {
            path: '/welcome',
            name: 'one',
            routes: [
              {
                path: '/welcome/welcome',
                name: 'two',
                exact: true,
              },
            ],
          },
        ],
      },
      {
        path: '/demo',
        name: '例子',
      },
    ];
    const actionRef = React.createRef<{
      reload: () => void;
    }>();
    const html = render(
      <ProLayout
        suppressSiderWhenMenuEmpty
        actionRef={actionRef as unknown as ProLayoutProps['actionRef']}
        location={{ pathname: '/' }}
        menu={{
          request: async () => {
            return serviceData;
          },
        }}
      >
        <Button
          id="test_btn"
          onClick={() => {
            handleClick();
            serviceData = [];
            actionRef.current?.reload();
          }}
        >
          刷新菜单
        </Button>
      </ProLayout>,
    );

    await waitForWaitTime(1000);
    expect(html.baseElement.querySelectorAll('.ant-layout-sider').length).toBe(1);
    act(() => {
      html.baseElement.querySelector<HTMLDivElement>('#test_btn')?.click();
    });

    await waitForWaitTime(1000);
    expect(handleClick).toHaveBeenCalled();
    expect(html.baseElement.querySelectorAll('.ant-layout-sider').length).toBe(0);
  });
});
